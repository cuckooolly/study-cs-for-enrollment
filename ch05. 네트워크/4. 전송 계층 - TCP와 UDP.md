# 전송 계층 - TCP와 UDP

## TCP와 UDP의 목적과 특징
### 포트를 통한 프로세스 식별
- 패킷의 최종 송수신 대상은 호스트가 실행하는 프로세스
- 포트를 통해, 호스트 내 프로세스를 식별
  - 예시) localhost:80 → 호스트 내 웹 서버 프로세스
  - 전송 계층의 주 목적은 포트를 통해 프로세스를 식별하는 것
- 범위에 따른 포트 번호 종류
    - 잘 알려진 포트(Well-known Ports): 0 ~ 1023 // 주요 서비스에 할당된 포트
    - 등록된 포트(Registered Ports): 1024 ~ 49151 // 애플리케이션 별로 등록된 포트
    - 동적/사설 포트(Dynamic/Private Ports): 49152 ~ 65535 // 클라이언트가 임시로 사용하는 포트
- 잘 알려진 포트 번호들

| 포트 번호  | 서비스    |
|--------|--------|
| 20, 21 | FTP    |
| 22     | SSH    |
| 23     | Telnet |
| 25     | SMTP   |
| 53     | DNS    |
| 67, 68 | DHCP   |
| 80     | HTTP   |
| 110    | POP3   |
| 143    | IMAP   |
| 443    | HTTPS  |

### (비)신뢰성과 (비)연결형 보장

- 각 프로토콜별 특징
  - TCP(Transmission Control Protocol)
    - 신뢰할 수 있는 통신: 상태 관리, 흐름 제어, 오류 제어, 혼잡 제어 제공
    - 연결형 통신: 연결 수립, 종료 과정 제공
  - UDP(User Datagram Protocol)
  ![](https://csnote.net/assets/img/net/udp.png)
    - 신뢰할 수 없는 통신: 상태 관리, 흐름 제어, 오류 제어, 혼잡 제어 미제공
    - 비연결형 통신: 연결 수립, 종료 과정 미제공
- 각 프로토콜의 헤더
  - TCP 헤더 <br>
  ![](https://csnote.net/assets/img/net/tcp.png)
    - 순서번호: TCP 세그먼트의 순서를 나타내는 번호
    - 확인응답번호: 수신자가 다음에 기대하는 순서번호
    - 플래그: 제어 비트로, 연결 설정, 종료, 데이터 전송 제어
  - UDP 헤더 <br>
  ![](https://csnote.net/assets/img/net/udp.png)
    - 송신지 포트와 수신지 포트가 끝!
## TCP의 연결부터 종료까지
### TCP의 연결 수립
- 3-way Handshake 과정 (나머지는 Wireshark와 교재로 확인) <br>
![](https://csnote.net/assets/img/net/three_way_handshake.png)
  1. 클라이언트가 서버에 SYN 패킷 전송 (SYN=1, Seq=x)
  2. 서버가 클라이언트에 SYN-ACK 패킷 전송 (SYN=1, ACK=1, Seq=y, Ack=x+1)
  3. 클라이언트가 서버에 ACK 패킷 전송 (ACK=1, Seq=x+1, Ack=y+1)

- 연결 수립의 종류
  - 액티브 오픈: 연결을 요청하는 측에서 수행되는 연결 수립 과정
  - 패시브 오픈: 연결 요청을 수신하는 측에서 수행되는 연결 수립 과정

### TCP의 오류/흐름/혼잡 제어
- 재전송을 통한 오류 제어
  - 중복된 ACK 세그먼트가 도착한 경우, 재전송
  - 타임아웃이 발생한 경우, 재전송
- 흐름 제어
  - 수신 윈도우 크기 만큼의 데이터만 전송
    1. 수신 측이 수신 가능한 버퍼 크기를 송신 측에 알림
    2. 송신 측은 수신 윈도우 크기 내에서만 데이터 전송
- 혼잡 제어
  - 혼잡의 판단 기준: 중복된 ACK 수신, 타임아웃 발생
  - 혼잡 윈도우 크기 만큼의 데이터만 전송
    - 혼잡 제어 알고리즘을 통해 혼잡 윈도우 크기를 계산

### TCP의 종료
- 4-way Handshake 과정 <br>
![](https://csnote.net/assets/img/net/four_way_handshake.png)
  1. 종료를 원하는 측이 FIN 패킷 전송 (FIN=1)
  2. 상대 측이 ACK 패킷 전송 (ACK=1)
  3. 상대 측이 FIN 패킷 전송 (FIN=1)
  4. 종료를 원하는 측이 ACK 패킷 전송 (ACK=1)

- 종료의 종류
  - 액티브 클로즈: 먼저 연결을 종료하려는 호스트에 수행되는 연결 종료 과정
  - 패시브 클로즈: 상대 호스트가 연결 종료를 요청할 때 수행되는 연결 종료 과정

## TCP의 상태 관리
- TCP 상태 다이어그램 <br>
![](https://csnote.net/assets/img/net/tcp_state.png)

- TCP의 상태 정리
  - 연결이 수립되지 않았을 때: CLOSED, LISTEN
  - 연결 수집 과정: SYN-SENT, SYN-RECEIVED
  - 연결이 수립된 상태: ESTABLISHED
  - 연결 종료 과정: FIN-WAIT-1, FIN-WAIT-2, CLOSE-WAIT, CLOSING, LAST-ACK, TIME-WAIT
    - FIN-WAIT-1: 종료 요청을 보낸 후, 상대방의 확인 응답을 기다리는 상태
    - FIN-WAIT-2: 상대방의 종료 요청을 기다리는 상태
    - CLOSE-WAIT: 상대방의 종료 요청을 수신하고, 종료 요청에 대한 확인 응답을 보낸 상태
    - CLOSING: 양측이 동시에 종료 요청을 보낸 상태
    - LAST-ACK: 종료 요청에 대한 확인 응답을 보낸 후, 상대방의 확인 응답을 기다리는 상태
    - TIME-WAIT: 일정 시간 동안 대기하는 상태
  - 연결이 종료된 상태: CLOSED

# 참고자료
- https://csnote.net/
