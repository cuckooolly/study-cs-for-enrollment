# 프록시와 안정적인 트래픽
## 오리진 서버와 중간 서버: 포워드 프록시와 리버스 프록시

- 서버
  - 오리진 서버: 클라이언트에게 응답을 보낼 수 있는 HTTP 서버
  - 중간 서버: 클라이언트와 오리진 서버 사이에 위치하여 요청을 중계하는 서버
- 프록시
  - 포워드 프록시: 클라이언트 측에 위치하여 클라이언트의 요청을 대신 보내주는 중간 서버
  - 리버스 프록시: 서버 측에 위치하여 클라이언트의 요청을 오리진 서버로 전달하는 중간 서버
    <br>
    ![](https://csnote.net/assets/img/net/forward_proxy.png)
- 게이트웨이
  - 오리진 서버 앞에 위치하여 클라이언트의 요청을 처리하고 오리진 서버로 전달하는 중간 서버
    <br>
    ![](https://csnote.net/assets/img/net/reverse_proxy.png)
- 스트림
  - 업스트림: 상위 서버(오리진 서버 방향)로 데이터를 전송하는 방향
  - 다운스트림: 하위 서버(클라이언트 방향)로 데이터를 전송하는 방향
- 바운드
  - 인바운드: 네트워크 외부에서 내부로 들어오는 트래픽
  - 아웃바운드: 네트워크 내부에서 외부로 나가는 트래픽

## 고가용성: 로드 밸런싱과 스케일링
### 가용성
- 가용성: 컴퓨터 시스템이 특정 기능을 실제로 수행할 수 있는 시간의 비율
  - $가용성 = \frac{업 타임}{업 타임 + 다운 타임}$
  - 업타임: 시스템이 정상적으로 작동하는 시간
  - 다운타임: 시스템이 고장나거나 유지보수로 인해 작동하지 않는 시간
    - 과도한 트래픽, SW/HW 오류, 사이버 공격 등으로 발생
    - 결함 감내(Fault Tolerance): 시스템이 일부 구성 요소의 고장에도 불구하고 정상적으로 작동할 수 있는 능력
    - Failover: 시스템의 일부가 고장났을 때 자동으로 대체 시스템으로 전환하는 메커니즘

### 로드 밸런싱
- 로드 밸런싱
  - 트래픽의 고른 분배를 위해 로드 밸런서에 의해 수행되는 기술
  - 부하를 의미하는 단어인 로드(load)와 균형 유지를 나타내는 단어인 밸런싱(balancing)이 합쳐진 단어
  <br>
  
  ![](https://csnote.net/assets/img/net/load_balancing.png)
- 예시
  - L4 / L7 스위치
  - 전용 소프트웨어 (Nginx, HAProxy 등)

- 로드 밸런싱 알고리즘
  - 라운드 로빈 알고리즘: 단순히 서버를 돌아가며 부하를 전달하는 로드 밸런싱 알고리즘
  - 최소 연결 알고리즘: 연결이 적은 서버부터 우선적으로 부하를 전달하는 로드 밸런싱 알고리즘
  - 가중치 라운드 로빈 알고리즘: 라운드 로빈 알고리즘에 따라 동작하되, 가중치가 높은 서버가 더 많이 선택되어 더 많은 부하를 받게 하는 로드 밸런싱 알고리즘
  - 가중치 최소 연결 알고리즘: 최소 연결 알고리즘에 따라 동작하되, 가중치가 높은 서버가 더 많이 선택되어 더 많은 부하를 받게 하는 로드 밸런싱 알고리즘

### 스케일링: 스케일 업 / 스케일 다운 / 아웃 오토스케일링
- 스케일 업(수직적 확장): 기존 서버를 더 나은 성능으로 변경하는 방법
- 스케일 다운(수평적 확장): 기존 서버를 여러 개로 변경하는 방법
- 오토스케일링: 필요할 때마다 시스템을 동적으로 확장하고 축소하는 기능

## Nginx로 알아보는 로드 밸런싱

- ${nginx}/nginx.conf
```text
...
http {
  access_log /var/log/nginx/access.log; // 웹서버가 수신한 개별 요청 관련 로그
  error_log /var/log/nginx/error.log; // 웹서버가 발생시킨 에러 관련 로그
  ...
  include /etc/nginx/conf.d/*.conf; // conf.d 디렉토리 내의 모든 설정 파일 포함
  include /etc/nginx/sites-enabled/*; // sites-enabled 디렉토리 내의 모든 설정 파일 포함
}
```

- ${nginx}/conf.d/*.conf
```text
// 로드 밸런서 설정 예시
upstream backend_servers {
    server 10.10.10.2:80 weight=1; // 서버 1
    server 10.10.10.3:80 weight=2; // 서버 2
    server 10.10.10.4:80 backup;   // 백업 서버
}

server {
    listen 80; // 포트 80에서 수신 대기
    server_name example.com; // 도메인 이름 설정

    location / {
        proxy_pass http://backend_servers; // 백엔드 서버로 요청 전달
        proxy_set_header Host $host; // 원본 호스트 헤더 설정
        proxy_set_header X-Real-IP $remote_addr; // 클라이언트 IP 설정
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; // 프록시 체인 설정
    }
}
```

# 참고자료
- https://csnote.net/
- https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/
